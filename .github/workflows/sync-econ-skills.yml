name: Sync Econ AI Skills

on:
  # Run daily at 6:00 AM UTC
  schedule:
    - cron: '0 6 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Perform a dry run (no changes)'
        required: false
        default: 'false'
        type: boolean
      force:
        description: 'Force update all skills'
        required: false
        default: 'false'
        type: boolean

  # Run on push to relevant paths (for testing)
  push:
    paths:
      - 'econ-ai-skills/**'
      - '.github/workflows/sync-econ-skills.yml'

env:
  PYTHON_VERSION: '3.11'

jobs:
  check-source:
    name: Check for Updates
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      latest_sha: ${{ steps.check.outputs.latest_sha }}

    steps:
      - name: Check source repository for updates
        id: check
        run: |
          # Get the latest commit SHA from the source repository
          LATEST_SHA=$(curl -s https://api.github.com/repos/meleantonio/awesome-econ-ai-stuff/commits/main | jq -r '.sha')
          echo "latest_sha=$LATEST_SHA" >> $GITHUB_OUTPUT

          # For now, always proceed (the sync script handles deduplication)
          echo "has_updates=true" >> $GITHUB_OUTPUT

  sync-skills:
    name: Sync Skills
    runs-on: ubuntu-latest
    needs: check-source
    if: needs.check-source.outputs.has_updates == 'true'
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Run sync script
        id: sync
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd econ-ai-skills

          # Determine flags
          DRY_RUN=""
          FORCE=""
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            DRY_RUN="--dry-run"
          fi
          if [[ "${{ github.event.inputs.force }}" == "true" ]]; then
            FORCE="--force"
          fi

          # Run the sync
          python scripts/sync_econ_skills.py \
            --config config.yml \
            --output-report sync-report.md \
            --output-manifest manifest.json \
            $DRY_RUN $FORCE

          # Check if there are changes
          cd ..
          if [[ -n $(git status --porcelain econ-ai-skills/skills/) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.sync.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(econ-ai-skills): sync economics AI skills from awesome-econ-ai-stuff"
          title: "[Auto] Sync Econ AI Skills"
          body: |
            ## Automated Econ AI Skills Sync

            This PR was automatically generated by the Econ AI Skills sync workflow.

            ### Source Repository
            [meleantonio/awesome-econ-ai-stuff](https://github.com/meleantonio/awesome-econ-ai-stuff)

            ### Sync Report
            See the attached `sync-report.md` file for details on changes.

            ---
            *This is an automated pull request. Please review the changes before merging.*
          branch: auto/sync-econ-skills
          delete-branch: true
          labels: |
            automated
            econ-ai-skills
            dependencies

      - name: Upload sync report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-report
          path: |
            econ-ai-skills/sync-report.md
            econ-ai-skills/manifest.json
          retention-days: 30

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Econ AI Skills Sync Failed';
            const body = `
            ## Sync Failure Report

            The automated sync of economics AI skills failed.

            **Workflow Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Triggered by:** ${context.eventName}
            **Date:** ${new Date().toISOString()}

            Please investigate the workflow logs for details.
            `;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'sync-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['sync-failure', 'automated', 'econ-ai-skills']
              });
            }

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: sync-skills
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## Econ AI Skills Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.sync-skills.result }}" == "success" ]]; then
            echo "Sync completed successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "Sync encountered issues. Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi
